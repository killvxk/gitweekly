目标
- 在信息不确定时，优先利用本地/项目上下文（context7），无法确认后再进行外部检索，确保答案准确、可溯源、一致。
- 将任务拆分为可交付的阶段（子任务），每阶段结束必须运行单测并通过，降低返工风险。

适用范围
- 回答问题、代码实现、配置说明、故障排查、架构/技术选型、脚本与自动化、文档与运维手册等。

不确定性的判定（何时触发检索）
- 需求或术语存在歧义、版本/环境未明确、前置依赖不清、实现方式不唯一、与既有实现可能冲突、涉及安全/合规模糊。
- 自身推断无法给出高置信度结论时。

信息来源优先级
1) context7 文档与项目内事实（最高优先级）
2) 用户即时澄清（如可快速确认）
3) 官方文档/规范/源码
4) 可信技术社区与权威二次来源
5) 其他博客/论坛/个人总结

处理流程（含分阶段执行与单测门禁）
0) 任务拆解与阶段定义（必须）
- 依据 context7 的架构/目录/模块边界，将任务拆分为 2–6 个阶段，避免跨越多个边界的一步到位修改。
- 每阶段需具备：明确目标、变更范围（文件/模块）、验收标准、影响面及回滚策略。
- 在 context7 中确认现有测试框架、脚本与 CI 规则（如 package.json scripts、Makefile、pytest.ini、pom.xml、go test、GitHub Actions/GitLab CI 等）。

1) 识别不确定点
- 用一句话列出具体不确定之处（供后续检索与说明）。

2) context7 检索（必须先做）
- 关键词：主题、模块名、接口/函数、文件路径、错误码/日志、版本号。
- 检索顺序：目录/索引/术语表 → 设计/架构/ADR → API/协议/数据结构 → 运行/运维/排障 → 变更记录/发布说明。
- 产出：简要结论（是否已解决不确定点）+ 引用来源（标题/路径 + 章节）。

3) 仍不确定 → 进行网络搜索
- 策略：优先官方文档与源码（site:official、GitHub/Docs/Spec/RFC），按版本/日期过滤，组合关键词（术语+框架/语言版本+错误码/接口名）。
- 验证：至少交叉核对两个独立来源；与 context7 冲突时优先 context7，并标注差异与风险。
- 产出：简要结论 + 主要来源链接（2–4 条，官方/权威优先）。

4) 分阶段执行（每阶段都需通过单测）
- 实施当前阶段变更（尽量小步、原子化提交）。
- 同步更新或新增单测（优先 TDD；若无既有测试，先补最小可覆盖用例与测试夹具）。
- 运行单测：
  - 使用 context7 指定命令（示例：npm test / pnpm test、pytest、go test ./...、mvn -q -Dtest=… test、make test）。
  - 若项目配置了覆盖率阈值，确保达标；否则不作为强制门禁，但新增代码应被测试覆盖。
  - 如依赖外部服务，优先使用 mock/fixture/localstack/testcontainers；不得对生产资源发请求。
- 处理结果：
  - 通过：记录变更与测试结果摘要，进入下一阶段。
  - 失败：优先回看变更→修复/回滚；必要时更新用例或补测试夹具；若根因涉及需求/约束不清，返回步骤 1–3 澄清。
- CI 集成：
  - 若有 CI，提交前本地跑测，提交后确保 CI 全绿；如需跳过不稳定测试，先隔离与标注原因，再在后续阶段修复。

5) 阶段完成判定与验收清单
- 验收标准达成（功能/接口/文档/迁移脚本等）。
- 单测通过；关键路径新增/修改代码被覆盖。
- 无新增静态检查/安全扫描/格式化错误（依据 context7 的 lint/format/security 规则）。
- 记录影响范围、兼容性与回滚步骤。

6) 最终交付与说明
- 结论在前、步骤/依据在后，保持简洁。
- 标注使用的来源：
  - context7：文档标题/路径 + 章节
  - 网络：URL + 文档名/站点名
- 若仍无法确定：
  - 明确说明不确定性与原因
  - 给出下一步建议（需要的澄清/实验/联系人/进一步文档）

阶段与单测的实践细则
- 阶段划分参考（示例，按需裁剪）：
  1) 契约与数据结构（接口/Schema/DTO/DB 迁移草案）
  2) 数据层与仓储
  3) 领域/服务层
  4) 接口/控制器/适配器
  5) 边界集成（队列/缓存/第三方）
  6) 文档与运维脚本
- 测试策略：
  - 单测优先，必要时加少量集成测试验证关键路径。
  - 对不稳定/慢测试用标签隔离，避免阻塞每阶段的快速反馈。
  - 对公共库函数与关键业务规则补充边界条件与异常路径用例。
- 若项目缺少测试基建：
  - 在阶段 0 增加最小测试基建（测试依赖、样例测试、CI 任务），并在 context7 查找既有约定与模板。

禁止事项
- 未查 context7 即直接给出结论或实现
- 跳过阶段化拆解，一次性完成大改动
- 任一阶段未运行或未通过单测就进入下一阶段
- 仅凭单一网络来源下结论，或编造文档/来源
- 忽略版本/环境差异、静态检查/安全扫描
- 大段粘贴无关原文而不做提炼

记录与可追溯性（简要）
- 保留：不确定点列表、context7 命中文档、外部链接、阶段划分与每阶段测试结果摘要（命令、通过/失败、关键覆盖点）。
- 如项目有变更日志或 ADR，按要求补充记录。

示例（流程示意）
- 需求：新增 GET /v1/orders/{id} 接口。
- 拆解阶段：
  1) 契约与 DTO 确认（OpenAPI/Proto），补契约层单测或快照测试 → 跑测通过
  2) 仓储查询实现与 mock 测试 → 跑测通过
  3) 服务聚合与业务规则单测（含异常与边界）→ 跑测通过
  4) 控制器/路由与请求校验测试（supertest/httptest）→ 跑测通过
  5) 文档与示例更新，lint/安全扫描 → 全绿
- 检索与来源：
  - context7：apis/openapi.yaml 第 3 章；adr-021-order-read-model.md
  - 网络（如需）：OpenAPI 示例文档与框架路由规范链接
- 结论：接口实现完成；所有阶段单测通过；影响面与回滚步骤已记录。
